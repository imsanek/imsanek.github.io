<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <meta name="description" content="Бутик отель История в Алуште">
        <meta name="keywords" content="Бутик отель История в Алуште">
        <meta name="format-detection" content="telephone=no">
        <title>Бутик отель История в Алуште</title>
        <link href="admin.css" rel="stylesheet" type="text/css">
    
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous">
    </head>
    <body>
        <img src="../img/map2.jpg" alt="background" class="body_bg">
        <div class="panel">
            <div class="list">
                <div class="number" id="1">
                    <img src="https://hotel-istoria.ru/img/room/big_OxyU5.jpg" alt="Инь-Янь (студио)">
                        <span>
                            Инь-Янь ( люкс )
                        </span>                  
                </div>
                <div class="number" id="2">
                    <img src="https://hotel-istoria.ru/img/room/big_aQQEFc.JPG" alt="Благодать (студио)">
                    <span>
                        Благодать ( люкс )
                    </span>
                </div>
                <div class="number" id="3">
                    <img src="https://hotel-istoria.ru/img/room/big_2Zxdr.JPG" alt="Круизный (студио)">
                    <span>
                        Круиз ( люкс )
                    </span>
                </div>
                <div class="number" id="4">
                    <img src="https://hotel-istoria.ru/img/room/big_v2sGmD.JPG" alt="Традиция (люкс)">
                    <span>
                        Традиция ( люкс )
                    </span>
                </div>
                <div class="number" id="5">
                    <img src="https://hotel-istoria.ru/img/room/big_i10OB.JPG" alt="Шоколадница">
                    <span>
                        Шоколадница
                    </span>
                </div>
                <div class="number" id="6">
                    <img src="https://hotel-istoria.ru/img/room/big_mYuE4Y.JPG" alt="Азия">
                    <span>
                        Азия
                    </span>
                </div>
                <div class="number" id="7">
                    <img src="https://hotel-istoria.ru/img/room/big_fZMK9g.JPG" alt="Джаз">
                    <span>
                        Джаз
                    </span>
                </div>
                <div class="number" id="8">
                    <img src="https://hotel-istoria.ru/img/room/big_vSJvDC.JPG" alt="">
                    <span>
                        Прованс
                    </span>
                </div>
                <div class="number" id="9">
                    <img src="https://hotel-istoria.ru/img/room/big_aVkH5.JPG" alt="Дача «Лаванда»">
                    <span>
                        Дача «Лаванда»
                    </span>
                </div>
                <div class="number" id="10">
                    <img src="https://hotel-istoria.ru/img/room/big_u72XR3.JPG" alt="Дача «Розмарин»">
                    <span>
                        Дача «Розмарин»
                    </span>
                </div>
            </div>
        </div>
        <div class="table">
            <div class="calendar">
                <div class="month">
                    <span>Календарь брони</span>
                </div>
                <div class="calendar-block">
                    <div id="datepicker"></div>
                </div>
            </div>
            <div class="info">
                <span>Информация о бронировании</span><br>
                <br>
                <span>Имя:</span><br>
                <span class="name"></span><br>
                <span>Телефон:</span><br>
                <span class="phone"></span><br>
                <span>Почта:</span><br>
                <span class="email"></span><br>
            </div>
            <div class="navigation">
                <span style="
                font-size: 40px;
                text-align: center;
                margin-bottom: 20px;">Управление</span>
                <div>
                    <span>Минимальная бронь на:</span>
                    <select id="guests"> 
                        <option>1</option> 
                        <option>2</option>
                        <option>3</option>
                        <option>4</option>
                        <option>5</option>  
                    </select> дней<br>
                    <button class="button">Утвердить</button>
                </div>
                <div>
                    <span>% за ребёнка в номере:</span>
                    <select id="children"> 
                        <option>10</option> 
                        <option>20</option>
                        <option>30</option>
                        <option>40</option>
                        <option>50</option>  
                    </select> % <br>
                    <button class="button">Утвердить</button>
                </div>
                <div class="booking">
                    <span>Забронировать:</span><br>
                    <select id="number-selector">
                        <option value="1">Инь-Янь</option>
                        <option value="2">Благодать</option>
                        <option value="3">Круиз</option>
                        <option value="4">Традиция</option>
                        <option value="5">Шоколадница</option>
                        <option value="6">Азия</option>
                        <option value="7">Джаз</option>
                        <option value="8">Прованс</option>
                        <option value="9">«Лаванда»</option>
                        <option value="10">«Розмарин»</option>
                    </select><br><br>
                    <input class="booking-input" type="text" placeholder="Введите имя" id="name" name="form-text"><br><br>
                    <input class="booking-input" type="text" placeholder="Введите телефон" id="phone" name="form-text"><br><br>
                    <input class="booking-input" type="text" placeholder="Введите почту" id="email" name="form-text"><br>
                    <div class="calendar-first">
                        <div class="calendar-text">
                            Заезд
                        </div>
                        <input type="text" class="calendar-blocks" id="datepicker1" placeholder="Выберите дату">
                    </div>
                    <div class="calendar-last">
                        <div class="calendar-text">
                            Выезд
                        </div>
                        <input type="text" class="calendar-blocks" id="datepicker2" placeholder="Выберите дату">
                    </div>
                    <button class="book">Забронировать</button>
                </div>
                <div style="display: flex; align-items: center;">
                    <div class="color-block1"></div>
                    <span> - Свободно</span>
                </div>
                <div style="display: flex; align-items: center;">
                    <div class="color-block2"></div>
                    <span> - Забронировано</span>
                </div>
            </div>
            
        </div>
        <div style="width: 99%; display: flex;">
            <div style="width: 35%; text-align: right; font-size: 40px;">
                Необработанные заявки:
            </div>
            <div class="tickets">

            </div>
        </div>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script>
        function disableScroll() {
        // Получить текущую позицию прокрутки страницы
        scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        scrollLeft = window.pageXOffset || document.documentElement.scrollLeft,
            // при попытке прокрутки установить это значение на предыдущее
            window.onscroll = function() {
                window.scrollTo(scrollLeft, scrollTop);
            };
        }

        function enableScroll() {
            window.onscroll = function() {};
        }
        $(document).ready(function() {
        $.datepicker.regional['ru'] = {
            closeText: 'Закрыть',
            prevText: 'Предыдущий',
            nextText: 'Следующий',
            currentText: 'Сегодня',
            monthNames: ['Январь','Февраль','Март','Апрель','Май','Июнь','Июль','Август','Сентябрь','Октябрь','Ноябрь','Декабрь'],
            monthNamesShort: ['Янв','Фев','Мар','Апр','Май','Июн','Июл','Авг','Сен','Окт','Ноя','Дек'],
            dayNames: ['воскресенье','понедельник','вторник','среда','четверг','пятница','суббота'],
            dayNamesShort: ['вск','пнд','втр','срд','чтв','птн','сбт'],
            dayNamesMin: ['Вс','Пн','Вт','Ср','Чт','Пт','Сб'],
            weekHeader: 'Не',
            dateFormat: 'dd.mm.yy',
            firstDay: 1,
            isRTL: false,
            showMonthAfterYear: false,
            yearSuffix: ''
        };
        $.datepicker.setDefaults($.datepicker.regional['ru']);
        $(function(){
            $("#datepicker").datepicker();
            $("#datepicker1").datepicker();
            $("#datepicker2").datepicker();
            var date = new Date();
            date.setDate(date.getDate() + 1);
        
            $("#datepicker1").datepicker({
                minDate: date
            });
            $("#datepicker2").datepicker({
                minDate: date
            });
        });
        
        $.ajax({
            url: '../api/hotel.json',  
            method: 'get',             
            dataType: 'html',          
            success: function(data){   
                allJSON = JSON.parse(data);
            },
            error: function(jqXHR) {
                console.log(jqXHR.status);
                $('.info').append($('<section/>', {
                    'class': 'ERROR hidden',
                    text: 'ERROR: ' + jqXHR.status
                }))
                $('.ERROR').hide();
                $('.ERROR').fadeIn(1200);
            }
        });

        ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        function getDays(x, y){
            var days = 0;
                var date1 = new Date(x);
                var date2 = new Date(y);
                while (date1 <= date2) {
                    days++;
                    date1.setDate( date1.getDate() + 1 )
                }
                return days;
            }
        
        var ticketsJSON;
        var apiJSON;
        var allJSON;
        $.ajax({
                url: '../api/get-tickets.php',
                method: 'GET',
                context: this,
                dataType: "html",
                timeout: 8000,
                global: false
            }).done(function(data) {
                //console.log(JSON.parse(data));
                ticketsJSON = JSON.parse(data);
                $('.tickets').html(" ");
                if(ticketsJSON){
                    
                    for(var tick = 0; tick < ticketsJSON.length; tick++){
                        $('.tickets').append($('<div/>', {
                            'class': 'ticket-block',
                            text: '?',
                            'id': ticketsJSON[tick].id,
                            'target': tick
                        }));
                        $('.ticket-block:eq('+tick+')').click(function(){
                            disableScroll();
                            $('body').append($('<div/>', {
                                'class': 'pop-up'
                            })).append($('<div/>', {
                                'class': 'full-content'
                            }));

                            $('.pop-up').fadeIn(300).click(function(){
                                $(this).remove();
                                $('.full-content').remove();
                                enableScroll();
                            });

                            var currentTarget = $(this).attr('target');
                            var jsonTarget = $(this).attr('id');
                            console.log(jsonTarget)
                            
                            $('.full-content').hide().fadeIn(400).append($('<span/>', {
                                'class': 'full-text',
                                'text': 'Этап бронирования'
                            })).append($('<span/>', {
                                'class': 'full2-text',
                                'text': 'Имя: ' + ticketsJSON[currentTarget].name
                            })).append($('<span/>', {
                                'class': 'full2-text',
                                'text': 'Телефон: ' + ticketsJSON[currentTarget].phone
                            })).append($('<span/>', {
                                'class': 'full2-text',
                                'text': 'Почта: ' + ticketsJSON[currentTarget].email
                            })).append($('<span/>', {
                                'class': 'full2-text',
                                'text': 'Количество ночей: ' + ' c ' + ticketsJSON[currentTarget].date[0][0] + ' по ' + ticketsJSON[currentTarget].date[0][ticketsJSON[currentTarget].date[0].length-1]
                            })).append($('<span/>', {
                                'class': 'full2-text',
                                'text': 'Номер: ' + allJSON[jsonTarget-1].title
                            })).append($('<span/>', {
                                'class': 'full2-text',
                                'text': 'Ребёнок: ' + ticketsJSON[currentTarget].children
                            })).append($('<span/>', {
                                'class': 'full2-text',
                                'text': 'Сумма: ' + ticketsJSON[currentTarget].price
                            })).append($('<button/>', {
                                'class': 'final-booking',
                                'text': 'Подтвердить бронь'
                            })).append($('<button/>', {
                                'class': 'delete-booking',
                                'text': 'Отменить бронь'
                            }));

                            console.log(jsonTarget)
                            $('.delete-booking').click(function() {
                                $.ajax({
                                    url: '../api/delete.php',
                                    method: 'GET',
                                    data:{
                                            id: currentTarget-1,
                                        },
                                    context: this,
                                    dataType: "html",
                                    timeout: 8000,
                                    global: false
                                }).done(function(data) {
                                    console.log('удалил');
                                });
                                $('.pop-up').click();
                                $('.ticket-block:eq('+(currentTarget - 1)+')').remove();
                            });

                            $('.final-booking').click(function() {
                                console.log(allJSON[jsonTarget-2].id);
                                var query = allJSON[jsonTarget-2].id;
                                var url = '../api/add-date.php';
                                var phone = ticketsJSON[currentTarget-1].phone;
                                var name = ticketsJSON[currentTarget-1].name;
                                var email = ticketsJSON[currentTarget-1].email;
                                var date = ticketsJSON[currentTarget-1].date[0];
                                console.log(date, allJSON[jsonTarget-2].id);
                                var apiJSON;
                                
                                $.ajax({
                                    url: url,
                                    method: 'GET',
                                    data:{
                                            id: query,
                                            date: date,
                                            phone: phone,
                                            name: name,
                                            email: email
                                        },
                                    context: this,
                                    dataType: "html",
                                    timeout: 8000,
                                    global: false
                                }).done(function(data) {
                                    console.log('отправил');
                                }).fail(function(jqXHR) {
                                    console.log(jqXHR.status);
                                    $('.info').append($('<section/>', {
                                        'class': 'ERROR hidden',
                                        text: 'ERROR: ' + jqXHR.status
                                    }))
                                    $('.ERROR').hide();
                                    $('.ERROR').fadeIn(1200);
                                }).always(function() {
                                    $('.overlay').hide();
                                });
                                $('.delete-booking').click();
                            });
                            currentTarget++;
                        });
                    }
                }currentTarget = 0;
            });
        ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        var timeless;
        var hotel;
        $('.number').click(function() {
            var query = $(this).attr('id');
            hotel = $(this).attr('id');
            var url = '../api/get.php';
            $.ajax({
                url: url,
                method: 'GET',
                data:{
                        id: query
                    },
                context: this,
                dataType: "html",
                timeout: 8000,
                global: false
            }).done(function(data) {
                console.log(JSON.parse(data));
                apiJSON = JSON.parse(data);
                if(apiJSON)
                {
                    $('.red').removeClass('red');
                    for(var i = 0; i < apiJSON.dates.length; i++){
                        console.log(apiJSON.dates[i].date);
                        console.log(apiJSON.dates[i].name)
                        timeless = i;
                        for(var j = 0; j < apiJSON.dates[i].date.length; j++){
                                var x = $('td[data-month='+ (apiJSON.dates[i].date[j].split('-')[1]-1) +'] .ui-state-default:contains('+ apiJSON.dates[i].date[j].split('-')[0] +')')[0];
                                if(x){
                                x.classList.add("red");
                                x.setAttribute('name',apiJSON.dates[i].name);
                                x.setAttribute('phone',apiJSON.dates[i].phone);
                                x.setAttribute('email',apiJSON.dates[i].email);}
                            }
                        }
                        $('.red').hover(function(){
                            $('.name').text($(this).attr('name'));
                            $('.phone').text($(this).attr('phone'));
                            $('.email').text($(this).attr('email'));
                        });
                        console.log("Приехало");                                         
                }else { 
                    $('.info').append($('<section/>', {
                        'class': 'ERROR hidden',
                        text: 'ERROR: ' + apiJSON.error
                    }));
                    $('.ERROR').hide();
                    $('.ERROR').fadeIn(1200);
                }
            }).fail(function(jqXHR) {
                console.log(jqXHR.status);
                $('.info').append($('<section/>', {
                    'class': 'ERROR hidden',
                    text: 'ERROR: ' + jqXHR.status
                }))
                $('.ERROR').hide();
                $('.ERROR').fadeIn(1200);
            }).always(function() {
                $('.overlay').hide();
            });
        });
        //////
        $('.book').click(function() {
            var query = $('#number-selector').val();
            var url = '../api/add-date.php';
            var phone = $("#phone").val();
            var name = $("#name").val();
            var email = $("#email").val();
            var firstDate = $("#datepicker1").val().split('.').reverse().join('-')
            var lastDate = $("#datepicker2").val().split('.').reverse().join('-')
            var date1 = new Date(firstDate);
            var date2 = new Date(lastDate);
            var date = [];
            while (date1 <= date2) {
                var mounth;
                mounth = date1.getDate();
                var dateStr = mounth+"-"+(date1.getMonth()+1).toString()+"-"+date1.getFullYear().toString();
                date.push(dateStr);
                date1.setDate( date1.getDate() + 1 )
            }
            console.log(date);
            var apiJSON;
            
            $.ajax({
                url: url,
                method: 'GET',
                data:{
                        id: query,
                        date: date,
                        phone: phone,
                        name: name,
                        email: email
                    },
                context: this,
                dataType: "html",
                timeout: 8000,
                global: false
            }).done(function(data) {
                    console.log("Принудительная бронь");                                               
            }).fail(function(jqXHR) {
                console.log(jqXHR.status);
                $('.info').append($('<section/>', {
                    'class': 'ERROR hidden',
                    text: 'ERROR: ' + jqXHR.status
                }))
                $('.ERROR').hide();
                $('.ERROR').fadeIn(1200);
            }).always(function() {
                $('.overlay').hide();
            });
        });});
        ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    </script>
    </body>
    
</html>